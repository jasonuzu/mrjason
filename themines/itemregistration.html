<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cursed Item Generator</title>
<style>
  body {
    background:#0c0c10;
    color:#eaeaf0;
    font-family: system-ui, sans-serif;
    padding:20px;
  }
  button {
    background:#1e1e2b;
    color:white;
    border:1px solid #444;
    padding:10px 14px;
    cursor:pointer;
    margin-right:10px;
  }
  #itemBox {
    margin-top:20px;
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  #visual {
    width:180px;
    height:180px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0f0f14;
    border:1px solid #333;
  }
  pre {
    background:#0f0f14;
    padding:10px;
    max-width:600px;
    overflow:auto;
    font-size:12px;
  }
</style>
</head>
<body>

<h1>Cursed Item Generator</h1>
<p>Total World Catalogue: <span id="worldCount">0</span></p>

<button onclick="generateItem()">Generate Item</button>
<button onclick="downloadMetadata()">Export NFT Metadata</button>

<div id="itemBox">
  <div id="visual"></div>
  <pre id="data"></pre>
</div>

<script>
/* ================= CORE DATA ================= */

let WORLD_COUNT = 0;
let LAST_ITEM = null;

const BASE_OBJECTS = [
  "Bottle","Shoe","Key","Plate","Ring","Trash Can","Coin","Mug","Knife","Helmet"
];

const MATERIALS = [
  "Iron","Glass","Bone","Plastic","Stone","Wood","Cloth"
];

const MATERIAL_COLORS = {
  Iron:"#aaa",
  Glass:"#88d",
  Bone:"#eee",
  Plastic:"#f4f4f4",
  Stone:"#999",
  Wood:"#a0522d",
  Cloth:"#ccc"
};

const CURSE_TIERS = [
  {tier:"Minor Anomaly", category:1, weight:40},
  {tier:"Unpredictable Utility", category:2, weight:30},
  {tier:"Dual-Effect Artifact", category:3, weight:15},
  {tier:"Hazardous Implement", category:4, weight:7},
  {tier:"Volatile Relic", category:5, weight:4},
  {tier:"Dangerous Artifact", category:6, weight:3},
  {tier:"Cataclysmic Curse", category:7, weight:1}
];

const EFFECTS = {
  Somatic:["Enhancement","Restoration","Alteration"],
  Cognitive:["Clarity","Emotion","Perception"],
  Environmental:["Elemental Manipulation","Spatial Alteration","Temporal Influence"],
  Metaphysical:["Summoning","Binding","Divination"]
};

/* ================= UTILITIES ================= */

function hashString(str) {
  let h = 2166136261;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
  }
  return h >>> 0;
}

function seededRandom(seed) {
  seed ^= seed << 13; seed ^= seed >> 17; seed ^= seed << 5;
  return (seed >>> 0) / 4294967296;
}

function weightedPick(list, r) {
  let total = list.reduce((s,a)=>s+a.weight,0);
  let x = r * total;
  for (let i of list) {
    if ((x -= i.weight) <= 0) return i;
  }
  return list[list.length-1];
}

function pickEffects(seed) {
  let effects = {};
  for (let cat in EFFECTS) {
    let r = seededRandom(seed + cat.length);
    // Each category has a chance to have 1 effect
    if (r > 0.3) {
      const eidx = Math.floor(seededRandom(seed+cat.length*10)*EFFECTS[cat].length);
      effects[cat] = EFFECTS[cat][eidx];
    }
  }
  return effects;
}

/* ================= SVG GENERATOR ================= */

function generateSVG(seed, base, material, curseTier) {
  const w=160, h=160;
  const r = seededRandom(seed);
  let shape = "";
  
  // Generate SVG shapes based on base object
  switch(base) {
    case "Bottle": case "Mug":
      shape = `<rect x="50" y="30" width="60" height="90" rx="10"/>`; break;
    case "Ring": case "Coin":
      shape = `<circle cx="80" cy="80" r="35"/>`; break;
    case "Key":
      shape = `<rect x="40" y="70" width="80" height="15" rx="4"/>`; break;
    case "Plate":
      shape = `<ellipse cx="80" cy="80" rx="50" ry="20"/>`; break;
    case "Shoe":
      shape = `<path d="M40 100 q30 -40 80 0 l-10 20 q-40 0 -60 -20z"/>`; break;
    case "Trash Can":
      shape = `<rect x="50" y="40" width="60" height="80" rx="5"/>
               <rect x="45" y="30" width="70" height="10" rx="2"/>`; break;
    case "Knife":
      shape = `<rect x="70" y="40" width="20" height="80"/>
               <polygon points="60,40 100,40 80,10"/>`; break;
    case "Helmet":
      shape = `<ellipse cx="80" cy="70" rx="50" ry="35"/>
               <rect x="55" y="70" width="50" height="25"/>`; break;
    default:
      shape = `<rect x="50" y="50" width="60" height="60"/>`;
  }
  
  // Add corruption overlay for dangerous items
  const corruptOverlay = (curseTier.category>=4) ?
    `<line x1="0" y1="0" x2="${w}" y2="${h}" stroke="white" stroke-width="1" opacity="0.3"/>
     <line x1="0" y1="${h}" x2="${w}" y2="0" stroke="white" stroke-width="1" opacity="0.3"/>`
    : "";
  
  // Glow for cataclysmic / legendary
  const glow = (curseTier.category>=6) ? `filter="url(#glow)"` : "";
  
  return `
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
<defs>
  <filter id="glow"><feGaussianBlur stdDeviation="3" result="b"/>
    <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
  </filter>
</defs>
<g fill="${MATERIAL_COLORS[material]}" stroke="white" stroke-width="2" ${glow}>
  ${shape}
</g>
${corruptOverlay}
</svg>`;
}

/* ================= MAIN GENERATOR ================= */

function generateItem() {
  WORLD_COUNT++;
  document.getElementById("worldCount").textContent = WORLD_COUNT;
  
  const uid = hashString(WORLD_COUNT + Date.now() + Math.random()).toString(16);
  const seed = hashString(uid);

  const base = BASE_OBJECTS[Math.floor(seededRandom(seed)*BASE_OBJECTS.length)];
  const material = MATERIALS[Math.floor(seededRandom(seed+1)*MATERIALS.length)];
  const curseTier = weightedPick(CURSE_TIERS, seededRandom(seed+2));
  const effects = pickEffects(seed);

  const svg = generateSVG(seed, base, material, curseTier);

  LAST_ITEM = {
    uid,
    base,
    material,
    curse: curseTier.tier,
    curse_category: curseTier.category,
    effects,
    svg
  };
  
  document.getElementById("visual").innerHTML = svg;
  
  document.getElementById("data").textContent =
`UID: ${uid}
Base Object: ${base}
Material: ${material}
Curse Tier: ${curseTier.tier}
Curse Category: ${curseTier.category}
Effects: ${JSON.stringify(effects,null,2)}`;
}

/* ================= METADATA EXPORT ================= */

function downloadMetadata() {
  if(!LAST_ITEM) return;
  const svgBase64 = btoa(unescape(encodeURIComponent(LAST_ITEM.svg)));
  const metadata = {
    name:`Untitled Cursed Item #${WORLD_COUNT}`,
    description:"Procedurally generated cursed item from storyworld.",
    image:`data:image/svg+xml;base64,${svgBase64}`,
    uid:LAST_ITEM.uid,
    base:LAST_ITEM.base,
    material:LAST_ITEM.material,
    curse_tier:LAST_ITEM.curse,
    curse_category:LAST_ITEM.curse_category,
    effects:LAST_ITEM.effects,
    generator_version:"1.0.0"
  };
  const blob = new Blob([JSON.stringify(metadata,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download=`cursed_item_${LAST_ITEM.uid}.json`;
  a.click();
}
</script>
</body>
</html>
