<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cursed Item Generator</title>
<style>
  body {
    background:#0c0c10;
    color:#eaeaf0;
    font-family: system-ui, sans-serif;
    padding:20px;
  }
  button {
    background:#1e1e2b;
    color:white;
    border:1px solid #444;
    padding:10px 14px;
    cursor:pointer;
    margin-right:10px;
  }
  #itemBox {
    margin-top:20px;
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  #visual {
    width:160px;
    height:160px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#0f0f14;
    border:1px solid #333;
  }
  pre {
    background:#0f0f14;
    padding:10px;
    max-width:500px;
    overflow:auto;
    font-size:12px;
  }
</style>
</head>
<body>

<h1>Cursed Item Generator</h1>
<p>Total World Catalogue: <span id="worldCount">0</span></p>

<button onclick="generateItem()">Generate Item</button>
<button onclick="downloadMetadata()">Export NFT Metadata</button>

<div id="itemBox">
  <div id="visual"></div>
  <pre id="data"></pre>
</div>

<script>
/* ================= CORE DATA ================= */

let WORLD_COUNT = 0;
let LAST_ITEM = null;

const BASE_OBJECTS = [
  "Bottle Cap","Shoe","Key","Plate","Ring",
  "Trash Lid","Coin","Mug","Knife","Helmet"
];

const MATERIALS = [
  "Iron","Glass","Bone","Plastic","Stone","Wood","Cloth"
];

const MATERIAL_PATTERNS = {
  Iron: "url(#hatch)",
  Glass: "rgba(255,255,255,0.08)",
  Bone: "rgba(255,245,220,0.15)",
  Plastic: "rgba(255,255,255,0.1)",
  Stone: "url(#noise)",
  Wood: "url(#grain)",
  Cloth: "rgba(255,255,255,0.12)"
};

const CURSES = [
  { name:"Minor Anomaly", weight:40 },
  { name:"Unpredictable Utility", weight:30 },
  { name:"Dual Effect", weight:15 },
  { name:"Hazardous Implement", weight:10 },
  { name:"Cataclysmic Curse", weight:5 }
];

const RARITY = [
  { tier:"Common", weight:60 },
  { tier:"Uncommon", weight:25 },
  { tier:"Rare", weight:10 },
  { tier:"Legendary", weight:5 }
];

/* ================= UTILITIES ================= */

function hashString(str) {
  let h = 2166136261;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
  }
  return h >>> 0;
}

function seededRandom(seed) {
  seed ^= seed << 13; seed ^= seed >> 17; seed ^= seed << 5;
  return (seed >>> 0) / 4294967296;
}

function weightedPick(list, r) {
  let total = list.reduce((s,a)=>s+a.weight,0);
  let x = r * total;
  for (let i of list) {
    if ((x -= i.weight) <= 0) return i;
  }
  return list[list.length-1];
}

/* ================= SVG GENERATOR ================= */

function generateSVG(seed, base, material, curse, rarity) {
  const w = 120, h = 120;
  const r = seededRandom(seed);
  const distort = Math.floor(r * 18);
  const tilt = (seed % 30) - 15;
  const glow = rarity === "Legendary";

  let shape;
  if (base.includes("Bottle") || base.includes("Mug")) {
    shape = `<rect x="44" y="20" width="32" height="70" rx="${6+distort}" />`;
  } else if (base.includes("Ring") || base.includes("Coin")) {
    shape = `<circle cx="60" cy="60" r="${28+distort}" />`;
  } else if (base.includes("Key")) {
    shape = `<rect x="28" y="54" width="64" height="14" rx="4" />`;
  } else {
    shape = `<rect x="30" y="30" width="${60+distort}" height="${60-distort}" rx="6" />`;
  }

  const corruption =
    curse.includes("Hazardous") || curse.includes("Cataclysmic")
    ? `<path d="M20 70 L100 40" stroke="white" stroke-width="1" opacity="0.4"/>`
    : "";

  const legendaryGlow = glow
    ? `filter="url(#glow)" class="pulse"`
    : "";

  return `
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 ${w} ${h}"
     width="120" height="120">

<defs>
  <pattern id="hatch" width="4" height="4" patternUnits="userSpaceOnUse">
    <path d="M0 0 L4 4" stroke="white" stroke-width="0.5" opacity="0.2"/>
  </pattern>

  <pattern id="noise" width="6" height="6" patternUnits="userSpaceOnUse">
    <circle cx="1" cy="1" r="0.5" fill="white" opacity="0.2"/>
  </pattern>

  <pattern id="grain" width="8" height="8" patternUnits="userSpaceOnUse">
    <rect width="8" height="1" fill="white" opacity="0.12"/>
  </pattern>

  <filter id="glow">
    <feGaussianBlur stdDeviation="3" result="b"/>
    <feMerge>
      <feMergeNode in="b"/>
      <feMergeNode in="SourceGraphic"/>
    </feMerge>
  </filter>
</defs>

<style>
  .pulse {
    animation: pulse 3s infinite ease-in-out;
  }
  @keyframes pulse {
    0% { opacity:0.7 }
    50% { opacity:1 }
    100% { opacity:0.7 }
  }
</style>

<g transform="rotate(${tilt} 60 60)">
  <g fill="${MATERIAL_PATTERNS[material]}" stroke="white" stroke-width="2" ${legendaryGlow}>
    ${shape}
  </g>
  ${corruption}
</g>

</svg>`;
}

/* ================= MAIN GENERATOR ================= */

function generateItem() {
  WORLD_COUNT++;
  document.getElementById("worldCount").textContent = WORLD_COUNT;

  const uid = hashString(
    WORLD_COUNT + Date.now().toString() + Math.random().toString()
  ).toString(16);

  const seed = hashString(uid);

  const base = BASE_OBJECTS[Math.floor(seededRandom(seed) * BASE_OBJECTS.length)];
  const material = MATERIALS[Math.floor(seededRandom(seed+1) * MATERIALS.length)];
  const curse = weightedPick(CURSES, seededRandom(seed+2));
  const rarity = weightedPick(RARITY, seededRandom(seed+3));

  const svg = generateSVG(seed, base, material, curse.name, rarity.tier);

  document.getElementById("visual").innerHTML = svg;

  LAST_ITEM = {
    uid,
    base,
    material,
    curse: curse.name,
    rarity: rarity.tier,
    svg
  };

  document.getElementById("data").textContent =
`UID: ${uid}
Base Object: ${base}
Material: ${material}
Curse: ${curse.name}
Rarity: ${rarity.tier}`;
}

/* ================= METADATA EXPORT ================= */

function downloadMetadata() {
  if (!LAST_ITEM) return;

  const svgBase64 = btoa(unescape(encodeURIComponent(LAST_ITEM.svg)));

  const metadata = {
    name: `Untitled Cursed Item #${WORLD_COUNT}`,
    description: "A procedurally generated cursed object from an ever-expanding catalogue.",
    image: `data:image/svg+xml;base64,${svgBase64}`,
    attributes: [
      { trait_type:"Base Object", value:LAST_ITEM.base },
      { trait_type:"Material", value:LAST_ITEM.material },
      { trait_type:"Curse", value:LAST_ITEM.curse },
      { trait_type:"Rarity", value:LAST_ITEM.rarity }
    ],
    uid: LAST_ITEM.uid,
    generator_version: "1.0.0"
  };

  const blob = new Blob(
    [JSON.stringify(metadata, null, 2)],
    { type:"application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `cursed_item_${LAST_ITEM.uid}.json`;
  a.click();
}
</script>

</body>
</html>
