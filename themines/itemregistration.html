<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cursed Item Generator</title>
<style>
  body {
    background:#0e0e11;
    color:#e6e6eb;
    font-family: system-ui, sans-serif;
    padding:20px;
  }
  button {
    background:#1f1f2a;
    color:white;
    border:1px solid #444;
    padding:10px 14px;
    cursor:pointer;
  }
  #itemBox {
    margin-top:20px;
    display:flex;
    gap:20px;
  }
  svg {
    background:#111;
    border:1px solid #333;
  }
  pre {
    background:#111;
    padding:10px;
    overflow:auto;
    max-height:300px;
    font-size:12px;
  }
</style>
</head>
<body>

<h1>Cursed Item Generator</h1>
<p>Total World Catalogue: <span id="worldCount">0</span></p>

<button onclick="generateItem()">Generate Item</button>
<button onclick="downloadMetadata()">Export NFT Metadata</button>

<div id="itemBox">
  <div id="visual"></div>
  <pre id="data"></pre>
</div>

<script>
/* ---------------- CORE DATA ---------------- */

let WORLD_COUNT = 0;
let LAST_ITEM = null;

const BASE_OBJECTS = [
  "Bottle Cap","Shoe","Key","Plate","Ring",
  "Trash Lid","Coin","Mug","Knife","Helmet"
];

const MATERIALS = [
  "Iron","Glass","Bone","Plastic","Stone","Wood","Cloth"
];

const CURSES = [
  { name:"Minor Anomaly", weight:40 },
  { name:"Unpredictable Utility", weight:30 },
  { name:"Dual Effect", weight:15 },
  { name:"Hazardous Implement", weight:10 },
  { name:"Cataclysmic Curse", weight:5 }
];

const RARITY = [
  { tier:"Common", weight:60 },
  { tier:"Uncommon", weight:25 },
  { tier:"Rare", weight:10 },
  { tier:"Legendary", weight:5 }
];

/* ---------------- UTILITIES ---------------- */

function hashString(str) {
  let h = 2166136261;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
  }
  return h >>> 0;
}

function seededRandom(seed) {
  seed ^= seed << 13; seed ^= seed >> 17; seed ^= seed << 5;
  return (seed >>> 0) / 4294967296;
}

function weightedPick(list, r) {
  let total = list.reduce((s,a)=>s+a.weight,0);
  let x = r * total;
  for (let i of list) {
    if ((x -= i.weight) <= 0) return i;
  }
  return list[list.length-1];
}

/* ---------------- SVG GENERATOR ---------------- */

function generateSVG(seed, base) {
  const r = seededRandom(seed);
  const w = 120, h = 120;
  const distort = Math.floor(r * 20);
  const tilt = (seed % 30) - 15;

  let shape;

  if (base.includes("Bottle") || base.includes("Mug")) {
    shape = `<rect x="40" y="20" width="40" height="70" rx="${8+distort}" />`;
  } else if (base.includes("Ring") || base.includes("Coin")) {
    shape = `<circle cx="60" cy="60" r="${30+distort}" />`;
  } else if (base.includes("Key")) {
    shape = `<rect x="30" y="50" width="60" height="15" rx="4" />`;
  } else {
    shape = `<rect x="30" y="30" width="${60+distort}" height="${60-distort}" rx="6" />`;
  }

  return `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${w} ${h}">
  <g transform="rotate(${tilt} 60 60)">
    <g fill="none" stroke="white" stroke-width="2">
      ${shape}
    </g>
    <g fill="rgba(255,255,255,0.05)">
      ${shape}
    </g>
  </g>
</svg>`;
}

/* ---------------- MAIN GENERATOR ---------------- */

function generateItem() {
  WORLD_COUNT++;
  document.getElementById("worldCount").textContent = WORLD_COUNT;

  const uid = hashString(
    WORLD_COUNT + Date.now().toString() + Math.random().toString()
  ).toString(16);

  const seed = hashString(uid);

  const r1 = seededRandom(seed);
  const r2 = seededRandom(seed+1);
  const r3 = seededRandom(seed+2);

  const base = BASE_OBJECTS[Math.floor(r1 * BASE_OBJECTS.length)];
  const material = MATERIALS[Math.floor(r2 * MATERIALS.length)];
  const curse = weightedPick(CURSES, r3);
  const rarity = weightedPick(RARITY, seededRandom(seed+3));

  const svg = generateSVG(seed, base);
  document.getElementById("visual").innerHTML = svg;

  LAST_ITEM = {
    uid,
    base,
    material,
    curse: curse.name,
    rarity: rarity.tier,
    distortion: (seed % 1000) / 1000,
    svg
  };

  document.getElementById("data").textContent =
`UID: ${uid}
Base Object: ${base}
Material: ${material}
Curse: ${curse.name}
Rarity: ${rarity.tier}
Geometry Distortion: ${LAST_ITEM.distortion}`;
}

/* ---------------- METADATA EXPORT ---------------- */

function downloadMetadata() {
  if (!LAST_ITEM) return;

  const svgBase64 = btoa(unescape(encodeURIComponent(LAST_ITEM.svg)));

  const metadata = {
    name: `Untitled Cursed Item #${WORLD_COUNT}`,
    description: "A procedurally generated cursed object from an ever-expanding catalogue.",
    image: `data:image/svg+xml;base64,${svgBase64}`,
    attributes: [
      { trait_type:"Base Object", value:LAST_ITEM.base },
      { trait_type:"Material", value:LAST_ITEM.material },
      { trait_type:"Curse", value:LAST_ITEM.curse },
      { trait_type:"Rarity", value:LAST_ITEM.rarity },
      { trait_type:"Distortion", value:LAST_ITEM.distortion }
    ],
    uid: LAST_ITEM.uid,
    generator_version: "1.0.0"
  };

  const blob = new Blob(
    [JSON.stringify(metadata, null, 2)],
    { type:"application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `cursed_item_${LAST_ITEM.uid}.json`;
  a.click();
}
</script>

</body>
</html>
